language: ruby
rvm:
  - 1.9.3
  - 2.0.0 
  - 2.2.4
 
services:
 - mysql

env:
  global:
    # The global environment variables are available in all of the builds of a matrix.
    # Here it is used for the test result and code coverage directories and the database location.
    - CI_REPORTS=shippable/testresults COVERAGE_REPORTS=shippable/codecoverage
    - TEST_DB_HOST=127.0.0.1 TEST_DB_USERNAME=shippable MYSQL_PASSWORD="" TEST_DB_NAME=test MYSQL_PORT=3306
    
pre_ci_boot:
  image_name: drydock/u14ruball
  image_tag: prod

build:
  ci:
   - touch bundle
   - shippable_retry apt-get update && apt-get install -y libpq-dev imagemagick libmagickwand-dev libmysqlclient-dev phantomjs  
 #  - mysqladmin create my_test
   - mysql -uroot -e "GRANT ALL PRIVILEGES ON $TEST_DB_NAME.* TO $TEST_DB_USERNAME@$TEST_DB_HOST" 
   - bundle package --all
   - shippable_retry bundle install
   - ruby -v
    # Resetting the database in before_script makes sure that the database is always empty for consistent test results.
  #  - mysql -e 'DROP DATABASE IF EXISTS test;'
  #  - mysql -e 'CREATE DATABASE IF NOT EXISTS test;'
  #on_success:
  #  - test/on_success.sh test
  #on_failure:
  #  - test/on_failure.sh test


#cache: true
#archive: true
